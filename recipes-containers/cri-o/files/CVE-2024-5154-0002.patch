From 9dff01bb8f22be3afbe77993c26631249f003319 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Krzysztof=20Wilczy=C5=84ski?= <kwilczynski@redhat.com>
Date: Wed, 22 May 2024 21:28:16 +0900
Subject: [PATCH 2/2] server: warn about container /etc not being a regular
 directory MIME-Version: 1.0 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Krzysztof Wilczy≈Ñski <kwilczynski@redhat.com>

CVE: CVE-2024-5154

Upstream-Status: Backport [https://github.com/cri-o/cri-o/pull/8231/commits/9dff01bb8f22be3afbe77993c26631249f003319]

Signed-off-by: Archana Polampalli <archana.polampalli@windriver.com>
---
 server/container_create_linux.go | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/server/container_create_linux.go b/server/container_create_linux.go
index 79562e4..b68bc18 100644
--- a/server/container_create_linux.go
+++ b/server/container_create_linux.go
@@ -850,6 +850,19 @@ func (s *Server) createSandboxContainer(ctx context.Context, ctr ctrfactory.Cont
		rootPair = idtools.IDPair{UID: 0, GID: 0}
	}

+	etcPath := filepath.Join(mountPoint, "/etc")
+
+	// Warn users if the container /etc directory path points to a location
+	// that is not a regular directory. This could indicate that something
+	// might be afoot.
+	etc, err := os.Lstat(etcPath)
+	if err != nil && !os.IsNotExist(err) {
+		return nil, err
+	}
+	if err == nil && !etc.IsDir() {
+		log.Warnf(ctx, "Detected /etc path for container %s is not a directory", ctr.ID())
+	}
+
	// The /etc directory can be subjected to various attempts on the path (directory)
	// traversal attacks. As such, we need to ensure that its path will be relative to
	// the base (or root, if you wish) of the container to mitigate a container escape.
--
2.40.0
